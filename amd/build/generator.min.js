define(["jquery","core/templates","core/str"],(function(e,r,s){const t=document.getElementById("edai_course_generator_form"),i=t.querySelector(".prompt-container"),n=t.querySelector("#prompt-form"),o=t.querySelector(".generation-container"),l=t.querySelector("#course_description"),a=t.querySelector("#generate_course"),c=t.querySelector("#temp_course_files"),d=t.querySelector("#course_files"),f=t.querySelector("#file_names"),h=t.querySelector("#progress-spinner");return{init:function(){this.progress=0,this.adjustDescriptionHeight(),this.handleDragAndDrop(),a.addEventListener("click",(e=>{if(e.preventDefault(),0===this.progress)this.startProgress();else if(this.progress<100){let e=2;this.finishProgress(e)}else this.resetProgress()}))},adjustDescriptionHeight:function(){const e=l.clientHeight;l.addEventListener("input",(function(){const r=parseFloat(getComputedStyle(l).lineHeight),s=l.value.split("\n").length;let t;s*r<e?t=e:s<=9?(t=s*r,l.style.overflowY="hidden"):(t=9*r,l.style.overflowY="scroll"),t+=t>e?14:0,l.style.height=t+"px"}))},clearAllFiles:function(){let e=new DataTransfer;d.files=e.files,this.displayFileNames()},transferFiles:function(e){let r=Array.from(d.files);for(let s of e)r.some((e=>e.name===s.name&&e.size===s.size))||r.push(s);let s=new DataTransfer;for(let e of r)s.items.add(e);d.files=s.files,this.displayFileNames()},handleDragAndDrop:function(){let r=0;e("#prompt-form").bind({dragenter:function(e){e.preventDefault(),e.stopPropagation(),r++,i.classList.add("drag-over")},dragleave:function(e){e.preventDefault(),e.stopPropagation(),r--,0===r&&i.classList.remove("drag-over")}}),this.dropOnChildElements(n),c.addEventListener("change",(()=>{let e=Array.from(c.files);this.transferFiles(e)}))},dropOnChildElements:function(e){e.childNodes.forEach((e=>{this.dropOnChildElements(e),e.addEventListener("dragover",(e=>{e.preventDefault(),e.stopPropagation()})),e.addEventListener("drop",(e=>{e.preventDefault(),e.stopPropagation(),i.classList.remove("drag-over"),e.dataTransfer.files.length>0&&this.transferFiles(e.dataTransfer.files)}))}))},startProgress:function(){h.classList.add("spinner-border"),o.classList.replace("d-none","d-block");let e=setInterval((()=>{this.progress>=90&&clearInterval(e);let r=Math.floor(5*Math.random());this.setProgress(this.progress+r)}),1e3)},finishProgress:async function(e){h.classList.remove("spinner-border"),r.render("block_course_generator/success_message",{courseid:e}).then((e=>{o.innerHTML+=e})).catch((e=>{console.error("Error rendering template: ",e)})),this.setProgress(100)},resetProgress:function(){h.classList.remove("spinner-border"),o.classList.replace("d-block","d-none");let e=t.querySelector("#success_message_container");e&&e.remove(),this.clearAllFiles(),this.setProgress(0)},setProgress:function(e){this.progress=e;let r=t.querySelector(".s-progress--bar");r.style.width=`${e}%`,e>=100?r.classList.add("done"):r.classList.remove("done")},displayFileNames:function(){let e=[],s=0;for(let r=0;r<d.files.length;r++){const t=d.files[r];s+=t.size,e.push({name:t.name,size:this.formatFilesize(t.size)})}let t={hasFiles:e.length>0,totalSize:this.formatFilesize(s),files:e};r.render("block_course_generator/filenames",t).then((e=>{f.innerHTML=e,f.querySelectorAll(".delete-icon").forEach(((e,r)=>{let s=this,t=d.files[r].name;e.addEventListener("click",(function(){let r=e.getAttribute("aria-describedby");document.getElementById(r).remove();let i=new DataTransfer;for(let e=0;e<d.files.length;e++)d.files[e].name!==t&&i.items.add(d.files[e]);d.files=i.files,s.displayFileNames()}))}))})).catch((e=>{console.error("Error rendering template: ",e)}))},formatFilesize:e=>{const r=["bytes","KB","MB","GB","TB"];let s=0;for(;e>=1024&&s<r.length-1;)e/=1024,s++;return`${e.toFixed(1)} ${r[s]}`}}}));