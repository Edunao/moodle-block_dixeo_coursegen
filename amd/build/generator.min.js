define(["jquery","core/templates","core/str"],(function(e,s,r){const t=document.getElementById("edai_course_generator_form"),n=t.querySelector(".prompt-container"),o=t.querySelector("#prompt-form"),i=t.querySelector("#carousel-controls"),l=t.querySelector(".generation-container"),a=t.querySelector("#course_description"),c=t.querySelector("#generate_course"),d=t.querySelector("#temp_course_files"),f=t.querySelector("#course_files"),p=t.querySelector("#file_names"),u=t.querySelector("#progress-spinner");return{init:function(){this.progress=0,this.adjustDescriptionHeight(),this.handleDragAndDrop(),c.addEventListener("click",(e=>{e.preventDefault(),0===this.progress&&this.startProgress(),setTimeout((()=>{this.finishProgress(2)}),5e3)}))},adjustDescriptionHeight:function(){const e=a.clientHeight;a.addEventListener("input",(function(){const s=parseFloat(getComputedStyle(a).lineHeight),r=a.value.split("\n").length;let t;r*s<e?t=e:r<=9?(t=r*s,a.style.overflowY="hidden"):(t=9*s,a.style.overflowY="scroll"),t+=t>e?14:0,a.style.height=t+"px"}))},clearAllFiles:function(){let e=new DataTransfer;f.files=e.files,this.displayFileNames()},transferFiles:function(e){let s=Array.from(f.files);for(let r of e)s.some((e=>e.name===r.name&&e.size===r.size))||s.push(r);let r=new DataTransfer;for(let e of s)r.items.add(e);f.files=r.files,this.displayFileNames()},handleDragAndDrop:function(){let s=0;e("#prompt-form").bind({dragenter:function(e){e.preventDefault(),e.stopPropagation(),s++,n.classList.add("drag-over")},dragleave:function(e){e.preventDefault(),e.stopPropagation(),s--,0===s&&n.classList.remove("drag-over")}}),this.dropOnChildElements(o),d.addEventListener("change",(()=>{let e=Array.from(d.files);this.transferFiles(e)}))},dropOnChildElements:function(e){e.childNodes.forEach((e=>{this.dropOnChildElements(e),e.addEventListener("dragover",(e=>{e.preventDefault(),e.stopPropagation()})),e.addEventListener("drop",(e=>{e.preventDefault(),e.stopPropagation(),n.classList.remove("drag-over"),e.dataTransfer.files.length>0&&this.transferFiles(e.dataTransfer.files)}))}))},startProgress:function(){u.classList.add("spinner-border"),n.classList.replace("d-block","d-none"),l.classList.replace("d-none","d-block");let e=setInterval((()=>{this.progress>=90&&clearInterval(e);let s=Math.floor(5*Math.random());this.setProgress(this.progress+s)}),1e3)},finishProgress:async function(e){u.classList.remove("spinner-border"),s.render("block_course_generator/success_message",{courseid:e}).then((e=>{l.innerHTML+=e;let s=t.querySelector(".reset-prompt");s&&s.addEventListener("click",(()=>{this.resetProgress()}))})).catch((e=>{console.error("Error rendering template: ",e)})),this.setProgress(100)},resetProgress:function(){u.classList.remove("spinner-border"),n.classList.replace("d-none","d-block"),l.classList.replace("d-block","d-none");let e=t.querySelector("#success_message_container");e&&e.remove(),this.clearAllFiles(),this.setProgress(0)},setProgress:function(e){this.progress=e;let s=t.querySelector(".s-progress--bar");s.style.width=`${e}%`,e>=100?s.classList.add("done"):s.classList.remove("done")},displayFileNames:function(){let e=[],r=0;for(let s=0;s<f.files.length;s++){const t=f.files[s];r+=t.size,e.push({name:t.name,size:this.formatFilesize(t.size)})}let t=e.length>0,n={hasFiles:t,totalSize:this.formatFilesize(r),files:e};t?i.classList.add("d-none"):i.classList.remove("d-none"),s.render("block_course_generator/filenames",n).then((e=>{p.innerHTML=e,p.querySelectorAll(".delete-icon").forEach(((e,s)=>{let r=this,t=f.files[s].name;e.addEventListener("click",(function(){let s=e.getAttribute("aria-describedby");document.getElementById(s).remove();let n=new DataTransfer;for(let e=0;e<f.files.length;e++)f.files[e].name!==t&&n.items.add(f.files[e]);f.files=n.files,r.displayFileNames()}))}))})).catch((e=>{console.error("Error rendering template: ",e)}))},formatFilesize:e=>{const s=["bytes","KB","MB","GB","TB"];let r=0;for(;e>=1024&&r<s.length-1;)e/=1024,r++;return`${e.toFixed(1)} ${s[r]}`}}}));