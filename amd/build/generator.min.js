define(["jquery","core/ajax","core/templates","core/str"],(function(e,t,r,s){const o=document.getElementById("edai_course_generator_form"),l=o.querySelector(".prompt-container"),n=o.querySelector("#prompt-form"),i=o.querySelector(".generation-container"),a=o.querySelector("#course_description"),c=o.querySelector("#generate_course"),d=o.querySelector("#temp_course_files"),f=o.querySelector("#course_files"),p=o.querySelector("#file_names"),u=o.querySelector("#progress-spinner"),g=o.querySelector("#loader"),h=o.querySelector("#success_message_container");return{init:function(){this.progress=0;const t=a.clientHeight;a.addEventListener("input",(function(){const e=parseFloat(getComputedStyle(a).lineHeight),r=a.value.split("\n").length;let s;r*e<t?s=t:r<=9?(s=r*e,a.style.overflowY="hidden"):(s=9*e,a.style.overflowY="scroll"),s+=s>t?14:0,a.style.height=s+"px"})),c.addEventListener("click",(e=>{e.preventDefault(),g.classList.replace("d-none","d-block"),0===this.progress?(this.startProgress(g),u.classList.add("spinner-border"),i.classList.replace("d-none","d-block")):this.progress<100?(this.setProgress(g,100),h.classList.replace("d-none","d-block"),u.classList.remove("spinner-border")):(this.setProgress(g,0),h.classList.replace("d-block","d-none"),u.classList.remove("spinner-border"),i.classList.replace("d-block","d-none"),this.clearAllFiles())})),dragEnterCounter=0,e("#prompt-form").bind({dragenter:function(e){e.preventDefault(),e.stopPropagation(),dragEnterCounter++,l.classList.add("drag-over")},dragleave:function(e){e.preventDefault(),e.stopPropagation(),dragEnterCounter--,0===dragEnterCounter&&l.classList.remove("drag-over")}}),this.dropOnChildElements(n),d.addEventListener("change",(()=>{let e=Array.from(d.files);this.transferFiles(e)}))},clearAllFiles:function(){let e=new DataTransfer;f.files=e.files,this.displayFileNames()},transferFiles:function(e){let t=Array.from(f.files);for(let r of e)t.some((e=>e.name===r.name&&e.size===r.size))||t.push(r);let r=new DataTransfer;for(let e of t)r.items.add(e);f.files=r.files,this.displayFileNames()},dropOnChildElements:function(e){e.childNodes.forEach((e=>{this.dropOnChildElements(e),e.addEventListener("dragover",(e=>{e.preventDefault(),e.stopPropagation()})),e.addEventListener("drop",(e=>{e.preventDefault(),e.stopPropagation(),l.classList.remove("drag-over"),e.dataTransfer.files.length>0&&this.transferFiles(e.dataTransfer.files)}))}))},startProgress:function(e){let t=setInterval((()=>{this.progress>=90&&clearInterval(t);let r=Math.floor(5*Math.random());this.setProgress(e,this.progress+r)}),1e3)},setProgress:function(e,t){let r=e.querySelector(".s-progress--bar");r.style.width=`${t}%`,t>=100?r.classList.add("done"):r.classList.remove("done"),this.progress=t},displayFileNames:function(){let e=[],t=0;for(let r=0;r<f.files.length;r++){const s=f.files[r];t+=s.size,e.push({name:s.name,size:this.formatFilesize(s.size)})}let s={hasFiles:e.length>0,totalSize:this.formatFilesize(t),files:e};r.render("block_course_generator/filenames",s).then((e=>{p.innerHTML=e,p.querySelectorAll(".delete-icon").forEach(((e,t)=>{let r=this,s=f.files[t].name;e.addEventListener("click",(function(){let e=new DataTransfer;for(let t=0;t<f.files.length;t++)f.files[t].name!==s&&e.items.add(f.files[t]);f.files=e.files,this.closest("li").remove(),r.updateTotalSize()}))}))})).catch((e=>{console.error("Error rendering template: ",e)}))},formatFilesize:e=>{const t=["bytes","KB","MB","GB","TB"];let r=0;for(;e>=1024&&r<t.length-1;)e/=1024,r++;return`${e.toFixed(1)} ${t[r]}`},updateTotalSize:function(){let e=0;for(let t=0;t<f.files.length;t++){e+=f.files[t].size}let t=p.querySelector(".total-size");e>0?s.get_string("totalsize","block_course_generator",this.formatFilesize(e)).done((function(e){t.innerHTML=e})):t.innerHTML=""}}}));