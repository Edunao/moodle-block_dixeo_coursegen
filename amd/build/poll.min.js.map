{"version":3,"file":"poll.min.js","sources":["../src/poll.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module for course generator block.\n *\n * @module     block_dixeo_coursegen/poll\n * @author     Josemaria Bolanos <admin@mako.digital>\n * @copyright  2025 Dixeo (contact@dixeo.com)\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'core/ajax',\n    'core/notification',\n    'core/log'\n], function(Ajax, Notification, Log) {\n    const TERMINAL_STATES = new Set(['success', 'error']);\n    const MIN_INTERVAL_MS = 2000; // Start at 2s.\n    const MAX_INTERVAL_MS = 30000; // Cap at 30s.\n    const TOTAL_TIMEOUT_MS = 5 * 60 * 1000; // Stop after 5 minutes as a safety.`\n\n    /**\n     * Returns the input milliseconds with a random ±20% jitter applied.\n     * Useful for avoiding synchronized requests (\"thundering herd\" problem).\n     *\n     * @param {number} ms - The base time in milliseconds.\n     * @returns {number} The jittered time in milliseconds.\n     */\n    function withJitter(ms) {\n        // ±20% jitter to avoid thundering herds.\n        const delta = ms * 0.2;\n        return Math.round(ms + (Math.random() * 2 * delta - delta));\n    }\n\n    class Poller {\n        constructor(root) {\n            this.root = root;\n            this.taskid = root.dataset.taskid;\n            this.interval = MIN_INTERVAL_MS;\n            this.running = false;\n            this.startTime = Date.now();\n            this.timeoutHandle = null;\n\n            this.onVisibilityChange = this.onVisibilityChange.bind(this);\n            this.cleanup = this.cleanup.bind(this);\n        }\n\n        init() {\n            if (!this.taskid) {\n                Log.error('block_dixeo_coursegen/poll: missing data-taskid');\n                return;\n            }\n            this.running = true;\n            document.addEventListener('visibilitychange', this.onVisibilityChange);\n            window.addEventListener('beforeunload', this.cleanup);\n            this.tick(); // Fire immediately.\n        }\n\n        onVisibilityChange() {\n            if (document.hidden) {\n                // Pause while hidden to save resources; resume when visible.\n                this.clearTimer();\n            } else if (this.running) {\n                this.interval = MIN_INTERVAL_MS; // Reset cadence on resume.\n                this.tick();\n            }\n        }\n\n        scheduleNext() {\n            if (!this.running) {\n                return;\n            }\n            if (Date.now() - this.startTime > TOTAL_TIMEOUT_MS) {\n                this.running = false;\n                return;\n            }\n            this.clearTimer();\n            this.timeoutHandle = window.setTimeout(() => this.tick(), withJitter(this.interval));\n        }\n\n        clearTimer() {\n            if (this.timeoutHandle) {\n                clearTimeout(this.timeoutHandle);\n                this.timeoutHandle = null;\n            }\n        }\n\n        tick() {\n            if (document.hidden || !this.running) {\n                return;\n            }\n\n            Ajax.call([{\n                methodname: 'block_dixeo_coursegen_get_status',\n                args: {\n                    taskid: this.taskid,\n                    sesskey: M.cfg.sesskey\n                },\n            }])[0].then((data) => {\n                this.root.dataset.status = Number.isFinite(data.status) ? data.status : '';\n                this.root.dataset.timeupdated = data.timeupdated || '';\n\n                if (data.terminal || TERMINAL_STATES.has(data.status)) {\n                    this.running = false;\n                    this.clearTimer();\n                    return;\n                }\n\n                // Success path: gentle backoff up to cap.\n                this.interval = Math.min(this.interval * 1.5, MAX_INTERVAL_MS);\n                this.scheduleNext();\n                return;\n            }).catch((err) => {\n                // On error: show once and back off more aggressively.\n                Log.warn('block_dixeo_coursegen/poll error', err);\n                Notification.exception(err);\n                this.interval = Math.min(this.interval * 2, MAX_INTERVAL_MS);\n                this.scheduleNext();\n            });\n        }\n\n        cleanup() {\n            this.running = false;\n            this.clearTimer();\n            document.removeEventListener('visibilitychange', this.onVisibilityChange);\n            window.removeEventListener('beforeunload', this.cleanup);\n        }\n    }\n\n    return {\n        init(rootEl) {\n            const p = new Poller(rootEl);\n            p.init();\n            return p;\n        }\n    };\n});\n"],"names":["define","Ajax","Notification","Log","TERMINAL_STATES","Set","Poller","constructor","root","taskid","dataset","interval","running","startTime","Date","now","timeoutHandle","onVisibilityChange","this","bind","cleanup","init","document","addEventListener","window","tick","error","hidden","clearTimer","scheduleNext","setTimeout","ms","delta","Math","round","random","withJitter","clearTimeout","call","methodname","args","sesskey","M","cfg","then","data","status","Number","isFinite","timeupdated","terminal","has","min","catch","err","warn","exception","removeEventListener","rootEl","p"],"mappings":";;;;;;;;AAuBAA,oCAAO,CACH,YACA,oBACA,aACD,SAASC,KAAMC,aAAcC,WACtBC,gBAAkB,IAAIC,IAAI,CAAC,UAAW,gBAkBtCC,OACFC,YAAYC,WACHA,KAAOA,UACPC,OAASD,KAAKE,QAAQD,YACtBE,SArBW,SAsBXC,SAAU,OACVC,UAAYC,KAAKC,WACjBC,cAAgB,UAEhBC,mBAAqBC,KAAKD,mBAAmBE,KAAKD,WAClDE,QAAUF,KAAKE,QAAQD,KAAKD,MAGrCG,OACSH,KAAKT,aAILG,SAAU,EACfU,SAASC,iBAAiB,mBAAoBL,KAAKD,oBACnDO,OAAOD,iBAAiB,eAAgBL,KAAKE,cACxCK,QANDtB,IAAIuB,MAAM,mDASlBT,qBACQK,SAASK,YAEJC,aACEV,KAAKN,eACPD,SA9CO,SA+CPc,QAIbI,eACSX,KAAKN,UAGNE,KAAKC,MAAQG,KAAKL,UArDL,SAsDRD,SAAU,QAGdgB,kBACAZ,cAAgBQ,OAAOM,YAAW,IAAMZ,KAAKO,iBAjDtCM,UAEVC,MAAa,GAALD,UACPE,KAAKC,MAAMH,IAAsB,EAAhBE,KAAKE,SAAeH,MAAQA,QA8CUI,CAAWlB,KAAKP,aAG9EiB,aACQV,KAAKF,gBACLqB,aAAanB,KAAKF,oBACbA,cAAgB,MAI7BS,QACQH,SAASK,QAAWT,KAAKN,SAI7BX,KAAKqC,KAAK,CAAC,CACPC,WAAY,mCACZC,KAAM,CACF/B,OAAQS,KAAKT,OACbgC,QAASC,EAAEC,IAAIF,YAEnB,GAAGG,MAAMC,eACJrC,KAAKE,QAAQoC,OAASC,OAAOC,SAASH,KAAKC,QAAUD,KAAKC,OAAS,QACnEtC,KAAKE,QAAQuC,YAAcJ,KAAKI,aAAe,GAEhDJ,KAAKK,UAAY9C,gBAAgB+C,IAAIN,KAAKC,oBACrClC,SAAU,YACVgB,kBAKJjB,SAAWsB,KAAKmB,IAAoB,IAAhBlC,KAAKP,SA3FlB,UA4FPkB,kBAENwB,OAAOC,MAENnD,IAAIoD,KAAK,mCAAoCD,KAC7CpD,aAAasD,UAAUF,UAClB3C,SAAWsB,KAAKmB,IAAoB,EAAhBlC,KAAKP,SAlGlB,UAmGPkB,kBAIbT,eACSR,SAAU,OACVgB,aACLN,SAASmC,oBAAoB,mBAAoBvC,KAAKD,oBACtDO,OAAOiC,oBAAoB,eAAgBvC,KAAKE,gBAIjD,CACHC,KAAKqC,cACKC,EAAI,IAAIrD,OAAOoD,eACrBC,EAAEtC,OACKsC"}