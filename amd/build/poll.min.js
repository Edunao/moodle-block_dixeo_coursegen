/**
 * AMD module for course generator block.
 *
 * @module     block_dixeo_coursegen/poll
 * @author     Josemaria Bolanos <admin@mako.digital>
 * @copyright  2025 Dixeo (contact@dixeo.com)
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_dixeo_coursegen/poll",["core/ajax","core/notification","core/log"],(function(Ajax,Notification,Log){const TERMINAL_STATES=new Set(["success","error"]);class Poller{constructor(root){this.root=root,this.taskid=root.dataset.taskid,this.interval=2e3,this.running=!1,this.startTime=Date.now(),this.timeoutHandle=null,this.onVisibilityChange=this.onVisibilityChange.bind(this),this.cleanup=this.cleanup.bind(this)}init(){this.taskid?(this.running=!0,document.addEventListener("visibilitychange",this.onVisibilityChange),window.addEventListener("beforeunload",this.cleanup),this.tick()):Log.error("block_dixeo_coursegen/poll: missing data-taskid")}onVisibilityChange(){document.hidden?this.clearTimer():this.running&&(this.interval=2e3,this.tick())}scheduleNext(){this.running&&(Date.now()-this.startTime>3e5?this.running=!1:(this.clearTimer(),this.timeoutHandle=window.setTimeout((()=>this.tick()),function(ms){const delta=.2*ms;return Math.round(ms+(2*Math.random()*delta-delta))}(this.interval))))}clearTimer(){this.timeoutHandle&&(clearTimeout(this.timeoutHandle),this.timeoutHandle=null)}tick(){!document.hidden&&this.running&&Ajax.call([{methodname:"block_dixeo_coursegen_get_status",args:{taskid:this.taskid,sesskey:M.cfg.sesskey}}])[0].then((data=>{if(this.root.dataset.status=Number.isFinite(data.status)?data.status:"",this.root.dataset.timeupdated=data.timeupdated||"",data.terminal||TERMINAL_STATES.has(data.status))return this.running=!1,void this.clearTimer();this.interval=Math.min(1.5*this.interval,3e4),this.scheduleNext()})).catch((err=>{Log.warn("block_dixeo_coursegen/poll error",err),Notification.exception(err),this.interval=Math.min(2*this.interval,3e4),this.scheduleNext()}))}cleanup(){this.running=!1,this.clearTimer(),document.removeEventListener("visibilitychange",this.onVisibilityChange),window.removeEventListener("beforeunload",this.cleanup)}}return{init(rootEl){const p=new Poller(rootEl);return p.init(),p}}}));

//# sourceMappingURL=poll.min.js.map