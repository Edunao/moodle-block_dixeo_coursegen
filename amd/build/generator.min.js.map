{"version":3,"file":"generator.min.js","sources":["../src/generator.js"],"sourcesContent":["define([\n    'jquery',\n    'core/templates',\n    'core/notification',\n    'core/str'\n], function($, Template, Notification, Str) {\n    const generatorForm         = document.getElementById('edai_course_generator_form');\n    const promptContainer       = generatorForm.querySelector('.prompt-container');\n    const promptForm            = generatorForm.querySelector('#prompt-form');\n    const generationContainer   = generatorForm.querySelector('.generation-container');\n    const courseDescription     = generatorForm.querySelector('#course_description');\n    const generateCourse        = generatorForm.querySelector('#generate_course');\n    const tempCourseFiles       = generatorForm.querySelector('#temp_course_files');\n    const courseFiles           = generatorForm.querySelector('#course_files');\n    const filesContainer        = generatorForm.querySelector('#file_names');\n\n    return {\n        init: function(generationURL) {\n            this.progress = 0;\n\n            this.adjustDescriptionHeight();\n            this.handleDragAndDrop();\n\n            // Trigger generation if course description is filled on page load.\n            if (courseDescription.value.trim() !== '') {\n                setTimeout(() => {\n                    generateCourse.click();\n                }, 1000);\n            }\n\n            // Add event listener to trigger generation on pressing Enter in the course description.\n            courseDescription.addEventListener('keydown', (event) => {\n                if (event.key === 'Enter' && !event.shiftKey) {\n                    event.preventDefault();\n                    generateCourse.click();\n                }\n            });\n\n            // Add event listener to generate course button.\n            generateCourse.addEventListener('click', (event) => {\n                event.preventDefault();\n\n                // Check if the course description is filled or files are uploaded.\n                if (courseDescription.value.trim() === '' && courseFiles.files.length === 0) {\n                    this.notify('invalidinput', 'descriptionorfilesrequired');\n                    return;\n                }\n\n                if (this.progress === 0) {\n                    this.startProgress();\n                }\n\n                const formdata = new FormData();\n                formdata.append('description', courseDescription.value);\n                for (let i = 0; i < courseFiles.files.length; i++) {\n                    formdata.append('course_files[]', courseFiles.files[i]);\n                }\n\n                fetch(generationURL, {\n                    method: 'POST',\n                    body: formdata\n                })\n                .then(response => {\n                    return response.json().then(data => {\n                        if (!response.ok) {\n                            this.resetProgress();\n                            throw new Error(\n                                response.status === 402 ? data.error : 'Oops, error during course creation. Please try again.'\n                            );\n                        }\n                        return data;\n                    });\n                })\n                .then(data => {\n                    const courseid = data.courseid;\n                    const coursename = data.coursename;\n                    this.finishProgress(courseid, coursename);\n                })\n                .catch(error => {\n                    this.resetProgress();\n                    Notification.alert('', error.message);\n                });\n            });\n        },\n        adjustDescriptionHeight: function() {\n            // Adjust course description height.\n            courseDescription.addEventListener('input', function() {\n            this.style.height = 'auto'; // Reset height\n            const maxHeight = parseFloat(getComputedStyle(this).lineHeight) * 9; // 9 lines max\n            this.style.overflowY = 'hidden';\n\n            if (this.scrollHeight > maxHeight) {\n                this.style.height = maxHeight + 'px';\n                this.style.overflowY = 'scroll';\n            } else {\n                this.style.height = this.scrollHeight + 'px';\n            }\n        });\n        },\n        clearAllFiles: function() {\n            let dataTransfer = new DataTransfer();\n            courseFiles.files = dataTransfer.files;\n            this.displayFileNames();\n        },\n        transferFiles: function(newFiles) {\n            // Validate files.\n            const maxfilesize = 20 * 1024 * 1024;  // 20 MB\n            const maxtotalsize = 50 * 1024 * 1024; // 50 MB\n            this.maxtotalsize = maxtotalsize;\n            const allowedtypes = [\n                'application/vnd.openxmlformats-officedocument.presentationml.presentation',\n                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n                'application/pdf',\n                'text/plain'\n            ];\n\n            let totalSize = 0;\n            let existingFiles = Array.from(courseFiles.files);\n\n            // Include the size of files already added to courseFiles.\n            for (let file of existingFiles) {\n                totalSize += file.size;\n            }\n\n            for (let file of newFiles) {\n                // Check file type.\n                if (!allowedtypes.includes(file.type)) {\n                    this.notify('uploaderror', ['filetypeinvalid', file.name]);\n                    return;\n                }\n                // Check file size.\n                totalSize += file.size;\n                if (file.size > maxfilesize) {\n                    this.notify('uploaderror', ['filetoolarge', file.name]);\n                    return;\n                }\n                // Check total size.\n                if (totalSize > maxtotalsize) {\n                    this.notify('uploaderror', 'totaltoolarge');\n                    return;\n                }\n            }\n\n            // Combine existing files with new files.\n            for (let file of newFiles) {\n                // Check if file already exists.\n                if (!existingFiles.some(existingFile => existingFile.name === file.name && existingFile.size === file.size)) {\n                    existingFiles.push(file);\n                }\n            }\n\n            // Add all files to DataTransfer\n            let dataTransfer = new DataTransfer();\n            for (let file of existingFiles) {\n                dataTransfer.items.add(file);\n            }\n\n            courseFiles.files = dataTransfer.files;\n            this.displayFileNames();\n        },\n        handleDragAndDrop: function() {\n            // Drag over and leave over prompt form.\n            let dragEnterCounter = 0;\n            $('#prompt-form').bind({\n                dragenter: function(event) {\n                    event.preventDefault();\n                    event.stopPropagation();\n                    dragEnterCounter++;\n                    promptContainer.classList.add('drag-over');\n                },\n                dragleave: function(event) {\n                    event.preventDefault();\n                    event.stopPropagation();\n                    dragEnterCounter--;\n                    if (dragEnterCounter === 0) {\n                        promptContainer.classList.remove('drag-over');\n                    }\n                },\n            });\n\n            // Apply drop listeners to all child elements of prompt form.\n            this.dropOnChildElements(promptForm);\n            // Move files from temp to course files.\n            tempCourseFiles.addEventListener('change', () => {\n                let newFiles = Array.from(tempCourseFiles.files);\n                this.transferFiles(newFiles);\n            });\n        },\n        dropOnChildElements: function(node) {\n            node.childNodes.forEach(child => {\n                this.dropOnChildElements(child);\n\n                child.addEventListener(\"dragover\", (event) => {\n                    event.preventDefault();\n                    event.stopPropagation();\n                });\n\n                child.addEventListener(\"drop\", (event) => {\n                    event.preventDefault();\n                    event.stopPropagation();\n                    promptContainer.classList.remove('drag-over');\n\n                    if (event.dataTransfer.files.length > 0) {\n                        this.transferFiles(event.dataTransfer.files);\n                    }\n                });\n            });\n        },\n        startProgress: function() {\n            generateCourse.disabled = true;\n            promptContainer.classList.replace('d-block', 'd-none');\n            generationContainer.classList.replace('d-none', 'd-block');\n\n            let interval = setInterval(() => {\n                if (this.progress >= 90) {\n                    clearInterval(interval);\n                }\n\n                // Increase by a random amount every second\n                let increment = Math.floor(Math.random() * 5);\n                this.setProgress(this.progress + increment);\n            }, 1000);\n        },\n        finishProgress: async function(courseid, coursename) {\n            Template.render('block_dixeo_coursegen/success_message', {courseid: courseid, coursename: coursename}).then((html) => {\n                this.setProgress(100);\n                generationContainer.parentElement.insertAdjacentHTML('beforeend', html);\n                generationContainer.classList.replace('d-block', 'd-none');\n            }).catch((error) => {\n                Notification.exception(error);\n            });\n        },\n        resetProgress: function() {\n            generateCourse.disabled = false;\n            promptContainer.classList.replace('d-none', 'd-block');\n            generationContainer.classList.replace('d-block', 'd-none');\n\n            courseDescription.value = '';\n\n            let successContainer = generatorForm.querySelector('#success_message_container');\n            if (successContainer) {\n                successContainer.remove();\n            }\n\n            this.clearAllFiles();\n\n            this.setProgress(0);\n        },\n        setProgress: function(progress) {\n            this.progress = progress;\n\n            let progressBar = generatorForm.querySelector('.s-progress--bar');\n            if (progressBar) {\n                progressBar.style.width = `${progress}%`;\n                if (progress >= 100) {\n                    progressBar.classList.add('done');\n                } else {\n                    progressBar.classList.remove('done');\n                }\n            }\n        },\n        displayFileNames: function() {\n            let contextFiles = [];\n            let totalSize = 0;\n            for (let i = 0; i < courseFiles.files.length; i++) {\n                const file = courseFiles.files[i];\n                totalSize += file.size;\n                contextFiles.push({\n                    name: file.name,\n                    size: this.formatFilesize(file.size),\n                });\n            }\n            let hasFiles = contextFiles.length > 0;\n            let context = {\n                hasFiles: hasFiles,\n                totalSize: this.formatFilesize(totalSize),\n                maxTotalSize : this.formatFilesize(this.maxtotalsize),\n                files: contextFiles\n            };\n\n            Template.render('block_dixeo_coursegen/filenames', context).then((html) => {\n                filesContainer.innerHTML = html;\n\n                let deleteIcons = filesContainer.querySelectorAll('.delete-icon');\n                deleteIcons.forEach((deleteIcon, index) => {\n                    let that = this;\n                    let toDelete = courseFiles.files[index].name;\n\n                    deleteIcon.addEventListener('click', function() {\n                        // Remove file from display.\n                        let toolTipId = deleteIcon.getAttribute('aria-describedby');\n                        document.getElementById(toolTipId).remove();\n\n                        // Remove file from course files.\n                        let dataTransfer = new DataTransfer();\n                        for (let i = 0; i < courseFiles.files.length; i++) {\n                            if (courseFiles.files[i].name !== toDelete) {\n                                dataTransfer.items.add(courseFiles.files[i]);\n                            }\n                        }\n\n                        courseFiles.files = dataTransfer.files;\n                        that.displayFileNames();\n                    });\n                });\n\n            }).catch((error) => {\n                Notification.exception(error);\n            });\n        },\n        formatFilesize: (size) => {\n            const units = ['bytes', 'KB', 'MB', 'GB', 'TB'];\n            let unitIndex = 0;\n            while (size >= 1024 && unitIndex < units.length - 1) {\n                size /= 1024;\n                unitIndex++;\n            }\n            return `${size.toFixed(1)} ${units[unitIndex]}`;\n        },\n        notify: async function() {\n            let strings = [];\n            let component = 'block_dixeo_coursegen';\n\n            for (let i = 0; i < arguments.length; i++) {\n                if (Array.isArray(arguments[i])) {\n                    strings.push({\n                        key: arguments[i][0],\n                        component: component,\n                        param: arguments[i][1]\n                    });\n                } else {\n                    strings.push({\n                        key: arguments[i],\n                        component: component\n                    });\n                }\n            }\n\n            Str.get_strings(strings)\n            .done((s) => {\n                if (s.length > 1) {\n                    Notification.alert(s[0], s[1]);\n                } else {\n                    Notification.alert('', s[0]);\n                }\n            })\n            .fail(Notification.exception);\n        }\n    };\n});\n"],"names":["define","$","Template","Notification","Str","generatorForm","document","getElementById","promptContainer","querySelector","promptForm","generationContainer","courseDescription","generateCourse","tempCourseFiles","courseFiles","filesContainer","init","generationURL","progress","adjustDescriptionHeight","handleDragAndDrop","value","trim","setTimeout","click","addEventListener","event","key","shiftKey","preventDefault","files","length","notify","this","startProgress","formdata","FormData","append","i","fetch","method","body","then","response","json","data","ok","resetProgress","Error","status","error","courseid","coursename","finishProgress","catch","alert","message","style","height","maxHeight","parseFloat","getComputedStyle","lineHeight","overflowY","scrollHeight","clearAllFiles","dataTransfer","DataTransfer","displayFileNames","transferFiles","newFiles","maxtotalsize","allowedtypes","totalSize","existingFiles","Array","from","file","size","includes","type","name","some","existingFile","push","items","add","dragEnterCounter","bind","dragenter","stopPropagation","classList","dragleave","remove","dropOnChildElements","node","childNodes","forEach","child","disabled","replace","interval","setInterval","clearInterval","increment","Math","floor","random","setProgress","async","render","html","parentElement","insertAdjacentHTML","exception","successContainer","progressBar","width","contextFiles","formatFilesize","context","hasFiles","maxTotalSize","innerHTML","querySelectorAll","deleteIcon","index","that","toDelete","toolTipId","getAttribute","units","unitIndex","toFixed","strings","component","arguments","isArray","param","get_strings","done","s","fail"],"mappings":"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"}